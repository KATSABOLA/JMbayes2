<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Non-Gaussian Mixed Models â€¢ JMbayes2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Non-Gaussian Mixed Models">
<meta property="og:description" content="JMbayes2">
<meta property="og:image" content="https://drizopoulos.github.io/JMbayes2/reference/figures/square_logo.png">
<meta property="og:image:alt" content="JMbayes2: Extended Joint Models for Longitudinal and Time-to-Event Data">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@drizopoulos">
<meta name="twitter:site" content="@drizopoulos">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-YDBZ5DBBSP"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YDBZ5DBBSP');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">JMbayes2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/JMbayes2.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Competing_Risks.html">Competing Risks</a>
    </li>
    <li>
      <a href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a>
    </li>
    <li>
      <a href="../articles/Multi_State_Processes.html">Multi-State Processes</a>
    </li>
    <li>
      <a href="../articles/Non_Gaussian_Mixed_Models.html">Non-Gaussian Mixed Models</a>
    </li>
    <li>
      <a href="../articles/Recurring_Events.html">Recurrent Events</a>
    </li>
    <li>
      <a href="../articles/Transformation_Functions.html">Transformation Functions for Functional Forms</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/drizopoulos/JMbayes2/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Non-Gaussian Mixed Models</h1>
                        <h4 data-toc-skip class="author">Dimitris Rizopoulos</h4>
            
            <h4 data-toc-skip class="date">2022-02-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/JMbayes2/blob/HEAD/vignettes/Non_Gaussian_Mixed_Models.Rmd" class="external-link"><code>vignettes/Non_Gaussian_Mixed_Models.Rmd</code></a></small>
      <div class="hidden name"><code>Non_Gaussian_Mixed_Models.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="non-gaussian-joint-models-with-jmbayes2">Non-Gaussian Joint Models with JMbayes2<a class="anchor" aria-label="anchor" href="#non-gaussian-joint-models-with-jmbayes2"></a>
</h2>
<p>Taking advantage of the versatility of the <a href="https://drizopoulos.github.io/GLMMadaptive/" class="external-link"><strong>GLMMadaptive</strong></a> package, <strong>JMbayes2</strong> can fit joint models with several different types of mixed-effects models. The following examples illustrate these capabilities. All examples have the same structure, namely, first, a short motivation for each mixed-model is given, followed by a piece of R code simulating data from a joint model with the respective mixed-effects sub-model, closing by the syntax to fit the joint model. In this last part, the main difference per example is the call to <code>mixed_model()</code>.</p>
<div class="section level3">
<h3 id="beta-mixed-models">Beta mixed models<a class="anchor" aria-label="anchor" href="#beta-mixed-models"></a>
</h3>
<p>With very few exceptions, continuous outcomes that we wish to analyze have some natural bounds. For example, the levels of blood biomarker for a set of patients. However, often, the majority of the observations are located far away from these natural bounds, and an assumption of a normal distribution for the outcome can be safely done. In some settings though, we can have outcomes for which a substantial percentage of the observations are located near the boundaries leading to skewed or U-shaped distributions. For such longitudinal outcomes, a linear mixed model with normal error terms often does not provide a good fit. A natural alternative is to select a distribution that respects the bounded nature of the outcome. The most well-known distribution for such outcomes is the Beta distribution defined in the <span class="math inline">\((0, 1)\)</span> interval (<em>note:</em> a bounded outcome <span class="math inline">\(Y^*\)</span> in the <span class="math inline">\((a, b)\)</span> interval can be transformed to the <span class="math inline">\(Y = (Y^* - a) / (b - a)\)</span> in the <span class="math inline">\((0, 1)\)</span> interval).</p>
<p>The following piece of code illustrates how to simulate data from a joint model with a Beta mixed effects model. The default functional form is assumed, i.e., that the linear predictor <span class="math inline">\(\eta(t)\)</span> of the mixed model is associated with the hazard of an event at time <span class="math inline">\(t\)</span>. The linear predictor is related to the mean <span class="math inline">\(\mu(t)\)</span> of the Beta distribution under the logit link function, i.e., <span class="math inline">\(\log[\mu(t) / \{1 - \mu(t)\}] = \eta(t)\)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># number of subjects</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of measurements per subject</span>
<span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we construct a data frame with the design:</span>
<span class="co"># everyone has a baseline measurement, and then measurements at random </span>
<span class="co"># follow-up times up to t_max</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,
                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span>

<span class="co"># design matrices for the fixed and random effects</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>

<span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.2</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span>
<span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># precision parameter of the Beta distribution</span>
<span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span>
<span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random slopes</span>

<span class="co"># we simulate random effects</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># linear predictor</span>
<span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co"># mean of the Beta distribution</span>
<span class="va">mu_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span> <span class="co"># plogis(eta_y) = exp(eta_y) / (1 + exp(eta_y))</span>
<span class="co"># we simulate Beta longitudinal data</span>
<span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, shape1 <span class="op">=</span> <span class="va">mu_y</span> <span class="op">*</span> <span class="va">phi</span>, shape2 <span class="op">=</span> <span class="va">phi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">mu_y</span><span class="op">)</span><span class="op">)</span>
<span class="co"># we transform to (0, 1)</span>
<span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">DF</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">DF</span><span class="op">)</span>

<span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># fixed Type I censoring time</span>
<span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span>
<span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficients</span>
<span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span>
<span class="co"># linear predictor for the survival model</span>
<span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span>
<span class="co"># to simulate event times we use inverse transform sampling</span>
<span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span>
<span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span>
<span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span>
<span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span>
<span class="co"># zero. We do that below using the uniroot() function</span>
<span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># i denotes the subject</span>
  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span>
  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span>
    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span>
    <span class="co"># the linear predictor from the mixed model evaluated at time s</span>
    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span>
                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># we simulate the event times</span>
<span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span>
    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span>
<span class="op">}</span>

<span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span>
<span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span>
<span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span>
<span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span>

<span class="co"># we keep the longitudinal measurements before the event times</span>
<span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></code></pre></div>
<p>To fit the corresponding joint model, we fit first a Beta mixed model using the <code>beta.fam()</code> family object into the call of <code>mixed_model()</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span>
<span class="va">Beta_MixMod</span> <span class="op">&lt;-</span> <span class="fu">mixed_model</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,
                           family <span class="op">=</span> <span class="fu">beta.fam</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">Beta_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = Beta_MixMod, time_var = "time")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Descriptives:</span>
<span class="co">#&gt; Number of Groups: 200        Number of events: 158 (79%)</span>
<span class="co">#&gt; Number of Observations:</span>
<span class="co">#&gt;   y: 1182</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                   DIC      WAIC       LPML</span>
<span class="co">#&gt; marginal    -3450.017 -3380.026   883.3837</span>
<span class="co">#&gt; conditional -2732.619 -2047.928 -1825.7723</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random-effects covariance matrix:</span>
<span class="co">#&gt;                     </span>
<span class="co">#&gt;        StdDev   Corr</span>
<span class="co">#&gt; (Intr) 0.8345 (Intr)</span>
<span class="co">#&gt; time   0.5206 0.0401</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Survival Outcome:</span>
<span class="co">#&gt;             Mean  StDev    2.5%  97.5%      P   Rhat</span>
<span class="co">#&gt; sexfemale 0.0519 0.3129 -0.5443 0.6762 0.8813 1.0306</span>
<span class="co">#&gt; value(y)  0.8237 0.0907  0.6512 1.0215 0.0000 1.0919</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Longitudinal Outcome: y (family = beta, link = logit)</span>
<span class="co">#&gt;                   Mean  StDev    2.5%   97.5%      P   Rhat</span>
<span class="co">#&gt; (Intercept)    -2.7040 0.3729 -3.5028 -2.0194 0.0000 1.0016</span>
<span class="co">#&gt; sexfemale      -0.0444 0.5132 -1.0536  0.9672 0.9353 1.0048</span>
<span class="co">#&gt; time            0.4079 0.1119  0.1958  0.6358 0.0000 1.0026</span>
<span class="co">#&gt; sexfemale:time -0.0689 0.1524 -0.3768  0.2260 0.6504 1.0029</span>
<span class="co">#&gt; sigma           6.3734 0.6207  5.1487  7.5862 0.0000 1.0229</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; MCMC summary:</span>
<span class="co">#&gt; chains: 3 </span>
<span class="co">#&gt; iterations per chain: 3500 </span>
<span class="co">#&gt; burn-in per chain: 500 </span>
<span class="co">#&gt; thinning: 1 </span>
<span class="co">#&gt; time: 18 sec</span></code></pre></div>
<div align="right">
<a href="#top">Back to top</a>
</div>
</div>
<div class="section level3">
<h3 id="censored-linear-mixed-models">Censored linear mixed models<a class="anchor" aria-label="anchor" href="#censored-linear-mixed-models"></a>
</h3>
<p>Some continuous longitudinal outcomes may have a censored nature. A typical example of such outcomes is when we have limit of detection issues. That is, the values of the outcome cannot be detected below a specified threshold having to do with the (laboratory) equipment used to determine the measurements. In these settings and even if the complete data follow a normal distribution the observed censored data cannot be analyzed with a standard mixed model. The <code>mixed_model()</code> function can accommodate such outcomes using the <code>censored.normal()</code> family object.</p>
<p>The following piece of code simulates data from a joint model with a linear mixed model for the longitudinal outcomes, but applies censoring in the realized longitudinal observations.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># number of subjects</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="co"># number of measurements per subject</span>
<span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">14</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we construct a data frame with the design:</span>
<span class="co"># everyone has a baseline measurement, and then measurements at random </span>
<span class="co"># follow-up times up to t_max</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,
                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span>

<span class="co"># design matrices for the fixed and random effects</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>

<span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.2</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span>
<span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># errors' standard deviation</span>
<span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span>
<span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random slopes</span>

<span class="co"># we simulate random effects</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># linear predictor</span>
<span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co"># we simulate normal longitudinal data</span>
<span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, mean <span class="op">=</span> <span class="va">eta_y</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span>
<span class="co"># we assume that values below -4 are not observed, and set equal to -4</span>
<span class="va">DF</span><span class="op">$</span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">4</span><span class="op">)</span>
<span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">y</span>, <span class="op">-</span><span class="fl">4</span><span class="op">)</span>

<span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># fixed Type I censoring time</span>
<span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span>
<span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficients</span>
<span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span>
<span class="co"># linear predictor for the survival model</span>
<span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span>
<span class="co"># to simulate event times we use inverse transform sampling</span>
<span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span>
<span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span>
<span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span>
<span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span>
<span class="co"># zero. We do that below using the uniroot() function</span>
<span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># i denotes the subject</span>
  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span>
  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span>
    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span>
    <span class="co"># the linear predictor from the mixed model evaluated at time s</span>
    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span>
                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># we simulate the event times</span>
<span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span>
    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span>
<span class="op">}</span>

<span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span>
<span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span>
<span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span>
<span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span>

<span class="co"># we keep the longitudinal measurements before the event times</span>
<span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></code></pre></div>
<p>The corresponding joint model is fitted with the following syntax:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span>
<span class="va">CensNorm_MixMod</span> <span class="op">&lt;-</span>
    <span class="fu">mixed_model</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">ind</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,
                family <span class="op">=</span> <span class="fu">censored.normal</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">CensNorm_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = CensNorm_MixMod, time_var = "time")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Descriptives:</span>
<span class="co">#&gt; Number of Groups: 200        Number of events: 165 (82.5%)</span>
<span class="co">#&gt; Number of Observations:</span>
<span class="co">#&gt;   cbind(y, ind): 1346</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                  DIC     WAIC      LPML</span>
<span class="co">#&gt; marginal    3944.479 5158.480 -3607.168</span>
<span class="co">#&gt; conditional 4942.614 8082.614 -7775.281</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random-effects covariance matrix:</span>
<span class="co">#&gt;                     </span>
<span class="co">#&gt;        StdDev   Corr</span>
<span class="co">#&gt; (Intr) 1.0162 (Intr)</span>
<span class="co">#&gt; time   0.6827 0.1112</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Survival Outcome:</span>
<span class="co">#&gt;                        Mean  StDev    2.5%  97.5%      P   Rhat</span>
<span class="co">#&gt; sexfemale            0.4719 0.4490 -0.3919 1.3783 0.2989 1.0231</span>
<span class="co">#&gt; value(cbind(y, ind)) 0.7369 0.0723  0.6042 0.8847 0.0000 1.0127</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Longitudinal Outcome: cbind(y, ind) (family = censored normal, link = identity)</span>
<span class="co">#&gt;                   Mean  StDev    2.5%   97.5%      P   Rhat</span>
<span class="co">#&gt; (Intercept)    -2.2792 0.3385 -2.9567 -1.6202 0.0000 1.0001</span>
<span class="co">#&gt; sexfemale      -0.0300 0.4604 -0.9389  0.8670 0.9522 1.0005</span>
<span class="co">#&gt; time            0.3354 0.1354  0.0676  0.6013 0.0129 1.0026</span>
<span class="co">#&gt; sexfemale:time -0.1227 0.1881 -0.4962  0.2435 0.5171 1.0005</span>
<span class="co">#&gt; sigma           0.6826 0.0593  0.5833  0.8143 0.0000 1.0142</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; MCMC summary:</span>
<span class="co">#&gt; chains: 3 </span>
<span class="co">#&gt; iterations per chain: 3500 </span>
<span class="co">#&gt; burn-in per chain: 500 </span>
<span class="co">#&gt; thinning: 1 </span>
<span class="co">#&gt; time: 12 sec</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="studentss-t-mixed-models">Studentsâ€™s-t mixed models<a class="anchor" aria-label="anchor" href="#studentss-t-mixed-models"></a>
</h3>
<p>Outlying observations is a common occurring issue in practice. Several methods have been proposed in the literature for identifying such observations in the context of longitudinal data. However, removing such values from the analysis is in general not recommended unless we also have external information why these values are outlying. Hence, in these settings we would need to fit mixed models to accommodate these observations. A well-known approach to achieve this is to replace the normal distribution for the error terms in the linear mixed model with a Studentâ€™s-t distribution that has heavier tails.</p>
<p>The following syntax simulates data from a joint model with a Studentâ€™s-t mixed effects model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># number of subjects</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="co"># number of measurements per subject</span>
<span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">14</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we construct a data frame with the design:</span>
<span class="co"># everyone has a baseline measurement, and then measurements at random </span>
<span class="co"># follow-up times up to t_max</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,
                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span>

<span class="co"># design matrices for the fixed and random effects</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>

<span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.2</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span>
<span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># error standard deviation</span>
<span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span>
<span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random slopes</span>

<span class="co"># we simulate random effects</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># linear predictor</span>
<span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co"># we simulate Student's-t longitudinal data</span>
<span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">eta_y</span> <span class="op">+</span> <span class="va">sigma</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">rt</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, df <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>

<span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># fixed Type I censoring time</span>
<span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span>
<span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficients</span>
<span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span>
<span class="co"># linear predictor for the survival model</span>
<span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span>
<span class="co"># to simulate event times we use inverse transform sampling</span>
<span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span>
<span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span>
<span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span>
<span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span>
<span class="co"># zero. We do that below using the uniroot() function</span>
<span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># i denotes the subject</span>
  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span>
  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span>
    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span>
    <span class="co"># the linear predictor from the mixed model evaluated at time s</span>
    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span>
                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># we simulate the event times</span>
<span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span>
    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span>
<span class="op">}</span>

<span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span>
<span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span>
<span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span>
<span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span>

<span class="co"># we keep the longitudinal measurements before the event times</span>
<span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></code></pre></div>
<p>To fit the corresponding joint model we use the <code>students.t()</code> family object in the call to <code>mixed_model()</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span>
<span class="va">Stdt_MixMod</span> <span class="op">&lt;-</span>
    <span class="fu">mixed_model</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,
                family <span class="op">=</span> <span class="fu">students.t</span><span class="op">(</span>df <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>

<span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">Stdt_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = Stdt_MixMod, time_var = "time")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Descriptives:</span>
<span class="co">#&gt; Number of Groups: 200        Number of events: 165 (82.5%)</span>
<span class="co">#&gt; Number of Observations:</span>
<span class="co">#&gt;   y: 1347</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                  DIC      WAIC      LPML</span>
<span class="co">#&gt; marginal    6099.120  8580.923 -4025.727</span>
<span class="co">#&gt; conditional 7199.499 10986.952 -5653.860</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random-effects covariance matrix:</span>
<span class="co">#&gt;                     </span>
<span class="co">#&gt;        StdDev   Corr</span>
<span class="co">#&gt; (Intr) 1.0491 (Intr)</span>
<span class="co">#&gt; time   0.7045 0.0347</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Survival Outcome:</span>
<span class="co">#&gt;              Mean  StDev    2.5%  97.5%      P  Rhat</span>
<span class="co">#&gt; sexfemale -0.0083 0.2763 -0.5565 0.5258 0.9682 1.013</span>
<span class="co">#&gt; value(y)   0.4900 0.0592  0.3721 0.6029 0.0000 1.024</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Longitudinal Outcome: y (family = Student's-t, link = identity)</span>
<span class="co">#&gt;                   Mean  StDev    2.5%   97.5%      P   Rhat</span>
<span class="co">#&gt; (Intercept)    -2.3619 0.4480 -3.2414 -1.4987 0.0000 1.0013</span>
<span class="co">#&gt; sexfemale      -0.1159 0.6707 -1.4469  1.1986 0.8724 1.0012</span>
<span class="co">#&gt; time            0.3073 0.1510  0.0171  0.6013 0.0416 1.0029</span>
<span class="co">#&gt; sexfemale:time -0.0393 0.2142 -0.4652  0.3807 0.8513 1.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; MCMC summary:</span>
<span class="co">#&gt; chains: 3 </span>
<span class="co">#&gt; iterations per chain: 3500 </span>
<span class="co">#&gt; burn-in per chain: 500 </span>
<span class="co">#&gt; thinning: 1 </span>
<span class="co">#&gt; time: 12 sec</span></code></pre></div>
<div align="right">
<a href="#top">Back to top</a>
</div>
</div>
<div class="section level3">
<h3 id="negative-binomial-mixed-models">Negative binomial mixed models<a class="anchor" aria-label="anchor" href="#negative-binomial-mixed-models"></a>
</h3>
<p>Count longitudinal outcomes are typically modeled with the Poisson distribution. However, often these outcomes exhibit more variance than what is allowed from the Poisson distribution leading to the well-known problem of over-dispersion. To accommodate this over-dispersion typically the Negative Binomial distribution is used.</p>
<p>The following piece of code simulates data from a joint model for count longitudinal data that follow the Negative Binomial distribution:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># number of subjects</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># number of measurements per subject</span>
<span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we construct a data frame with the design:</span>
<span class="co"># everyone has a baseline measurement, and then measurements at random </span>
<span class="co"># follow-up times up to t_max</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,
                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span>

<span class="co"># design matrices for the fixed and random effects</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>

<span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span>
<span class="va">shape</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># shape/size parameter of the negative binomial distribution</span>
<span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span>
<span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.3</span> <span class="co"># variance of random slopes</span>

<span class="co"># we simulate random effects</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># linear predictor</span>
<span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co"># mean of the Beta distribution</span>
<span class="va">mu_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span> <span class="co"># plogis(eta_y) = exp(eta_y) / (1 + exp(eta_y))</span>
<span class="co"># we simulate negative binomial longitudinal data</span>
<span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, size <span class="op">=</span> <span class="va">shape</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span><span class="op">)</span>

<span class="co"># simulate event times</span>
<span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># fixed Type I censoring time</span>
<span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span>
<span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficient</span>
<span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span>
<span class="co"># linear predictor for the survival model</span>
<span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span>
<span class="co"># to simulate event times we use inverse transform sampling</span>
<span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span>
<span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span>
<span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span>
<span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span>
<span class="co"># zero. We do that below using the uniroot() function</span>
<span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># i denotes the subject</span>
  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span>
  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span>
    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span>
    <span class="co"># the linear predictor from the mixed model evaluated at time s</span>
    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span>
                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># we simulate the event times</span>
<span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span>
    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span>
<span class="op">}</span>

<span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span>
<span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span>
<span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span>
<span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span>

<span class="co"># we keep the longitudinal measurements before the event times</span>
<span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></code></pre></div>
<p>The corresponding joint model is the fitted using the following syntax:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span>
<span class="va">NB_MixMod</span> <span class="op">&lt;-</span> <span class="fu">mixed_model</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,
                         family <span class="op">=</span> <span class="fu">negative.binomial</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">NB_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = NB_MixMod, time_var = "time")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Descriptives:</span>
<span class="co">#&gt; Number of Groups: 500        Number of events: 409 (81.8%)</span>
<span class="co">#&gt; Number of Observations:</span>
<span class="co">#&gt;   y: 3842</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                  DIC     WAIC      LPML</span>
<span class="co">#&gt; marginal    22130.00 22043.16 -11025.00</span>
<span class="co">#&gt; conditional 23720.47 23556.40 -12555.58</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random-effects covariance matrix:</span>
<span class="co">#&gt;                      </span>
<span class="co">#&gt;        StdDev   Corr </span>
<span class="co">#&gt; (Intr) 1.0152 (Intr) </span>
<span class="co">#&gt; time   0.5660 -0.0678</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Survival Outcome:</span>
<span class="co">#&gt;             Mean  StDev   2.5%  97.5% P   Rhat</span>
<span class="co">#&gt; sexfemale 0.5926 0.1691 0.2774 0.9312 0 1.0034</span>
<span class="co">#&gt; value(y)  0.7603 0.0561 0.6600 0.8699 0 1.0174</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Longitudinal Outcome: y (family = negative binomial, link = log)</span>
<span class="co">#&gt;                   Mean  StDev    2.5%   97.5%      P   Rhat</span>
<span class="co">#&gt; (Intercept)     0.7144 0.1766  0.3655  1.0619 0.0000 1.0021</span>
<span class="co">#&gt; sexfemale      -0.6164 0.2617 -1.1268 -0.1084 0.0191 1.0017</span>
<span class="co">#&gt; time            0.9130 0.0935  0.7293  1.0970 0.0000 1.0032</span>
<span class="co">#&gt; sexfemale:time -0.5101 0.1280 -0.7540 -0.2602 0.0000 1.0030</span>
<span class="co">#&gt; sigma           1.8781 0.0948  1.6895  2.0614 0.0000 1.0037</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; MCMC summary:</span>
<span class="co">#&gt; chains: 3 </span>
<span class="co">#&gt; iterations per chain: 3500 </span>
<span class="co">#&gt; burn-in per chain: 500 </span>
<span class="co">#&gt; thinning: 1 </span>
<span class="co">#&gt; time: 24 sec</span></code></pre></div>
<div align="right">
<a href="#top">Back to top</a>
</div>
</div>
<div class="section level3">
<h3 id="beta-binomial-longitudinal-outcomes">Beta-binomial longitudinal outcomes<a class="anchor" aria-label="anchor" href="#beta-binomial-longitudinal-outcomes"></a>
</h3>
<p>As for count data also for Binomial data we may have the over-dispersion problem. In this case, we can change to standard Binomial distribution to a Beta-Binomial one to accommodate this.</p>
<p>The following piece of code simulates data from a joint model for binomial longitudinal data that follow the Beta-Binomial distribution:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># number of subjects</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of measurements per subject</span>
<span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># maximum follow-up time</span>

<span class="co"># we construct a data frame with the design:</span>
<span class="co"># everyone has a baseline measurement, and then measurements at random </span>
<span class="co"># follow-up times up to t_max</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,
                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span>

<span class="co"># design matrices for the fixed and random effects</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>

<span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.2</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span>
<span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># precision parameter of the Beta distribution</span>
<span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span>
<span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random slopes</span>

<span class="co"># we simulate random effects</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># linear predictor</span>
<span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co"># mean of the Beta distribution</span>
<span class="va">mu_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span> <span class="co"># plogis(eta_y) = exp(eta_y) / (1 + exp(eta_y))</span>
<span class="co"># we simulate probabilities from the Beta distribution</span>
<span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, shape1 <span class="op">=</span> <span class="va">mu_y</span> <span class="op">*</span> <span class="va">phi</span>, shape2 <span class="op">=</span> <span class="va">phi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">mu_y</span><span class="op">)</span><span class="op">)</span>
<span class="co"># we transform to (0, 1)</span>
<span class="va">probs</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">probs</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">DF</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">DF</span><span class="op">)</span>
<span class="co"># we simulate binomial data use the probs</span>
<span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, size <span class="op">=</span> <span class="fl">20</span>, prob <span class="op">=</span> <span class="va">probs</span><span class="op">)</span>

<span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># fixed Type I censoring time</span>
<span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span>
<span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficients</span>
<span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span>
<span class="co"># linear predictor for the survival model</span>
<span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span>
<span class="co"># to simulate event times we use inverse transform sampling</span>
<span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span>
<span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span>
<span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span>
<span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span>
<span class="co"># zero. We do that below using the uniroot() function</span>
<span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># i denotes the subject</span>
  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span>
  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span>
    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span>
    <span class="co"># the linear predictor from the mixed model evaluated at time s</span>
    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span>
                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># we simulate the event times</span>
<span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span>
    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span>
<span class="op">}</span>

<span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span>
<span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span>
<span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span>
<span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span>

<span class="co"># we keep the longitudinal measurements before the event times</span>
<span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></code></pre></div>
<p>The corresponding joint model is then fitted with the syntax:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span>
<span class="va">BetaBinom_MixMod</span> <span class="op">&lt;-</span>
    <span class="fu">mixed_model</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">20</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,
                family <span class="op">=</span> <span class="fu">beta.binomial</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">BetaBinom_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = BetaBinom_MixMod, time_var = "time")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Descriptives:</span>
<span class="co">#&gt; Number of Groups: 500        Number of events: 395 (79%)</span>
<span class="co">#&gt; Number of Observations:</span>
<span class="co">#&gt;   cbind(y, 20 - y): 2837</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                  DIC     WAIC      LPML</span>
<span class="co">#&gt; marginal    12111.42 12043.71 -6040.707</span>
<span class="co">#&gt; conditional 14172.68 14142.71 -8617.415</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random-effects covariance matrix:</span>
<span class="co">#&gt;                      </span>
<span class="co">#&gt;        StdDev   Corr </span>
<span class="co">#&gt; (Intr) 1.1099 (Intr) </span>
<span class="co">#&gt; time   0.7476 -0.0324</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Survival Outcome:</span>
<span class="co">#&gt;                           Mean  StDev    2.5%  97.5%      P   Rhat</span>
<span class="co">#&gt; sexfemale               0.4483 0.3289 -0.1702 1.1190 0.1564 1.0100</span>
<span class="co">#&gt; value(cbind(y, 20 - y)) 0.7322 0.0577  0.6284 0.8448 0.0000 1.0593</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Longitudinal Outcome: cbind(y, 20 - y) (family = beta binomial, link = logit)</span>
<span class="co">#&gt;                   Mean  StDev    2.5%   97.5%      P   Rhat</span>
<span class="co">#&gt; (Intercept)    -2.2473 0.2651 -2.7986 -1.7532 0.0000 1.0065</span>
<span class="co">#&gt; sexfemale      -0.2854 0.3461 -0.9601  0.4051 0.4091 1.0026</span>
<span class="co">#&gt; time            0.3460 0.1026  0.1426  0.5504 0.0007 1.0079</span>
<span class="co">#&gt; sexfemale:time -0.1865 0.1334 -0.4469  0.0775 0.1660 1.0049</span>
<span class="co">#&gt; sigma           4.9695 0.3417  4.3168  5.6566 0.0000 1.0180</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; MCMC summary:</span>
<span class="co">#&gt; chains: 3 </span>
<span class="co">#&gt; iterations per chain: 3500 </span>
<span class="co">#&gt; burn-in per chain: 500 </span>
<span class="co">#&gt; thinning: 1 </span>
<span class="co">#&gt; time: 46 sec</span></code></pre></div>
<div align="right">
<a href="#top">Back to top</a>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="http://www.drizopoulos.com/" class="external-link">Dimitris Rizopoulos</a>, <a href="https://gregpapageorgiou.com/" class="external-link">Grigorios Papageorgiou</a>, <a href="https://pafonso.com/" class="external-link">Pedro Miranda Afonso</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '66a8ef39105517ba1ce2f07aa1c70890',
    indexName: 'drizopoulos',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
